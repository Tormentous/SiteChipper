<!DOCTYPE html>
<html>
<head>
  <title>Boards / Coolbrador</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <div id="shared-header"></div>
  <div class="boards-top-banner">
    <h1>Coolbrador Boards</h1>
    <div class="boards-search"><input type="text" placeholder="Search boards..." autocomplete="off"></div>
    <h2>For You</h2>
    <h3>Some posts will appear in game!</h3>
  </div>

  <section class="container bodytext-section">
    <div class="create-post-container" id="createPostBox">
      <div class="create-post">
        <div class="post-avatar">
          <img id="currentUserPfp" src="/users/default/pfp.jpg" alt="You">
        </div>
        <textarea id="newPostText" placeholder="Say something and watch what happens..."></textarea>
      </div>

      <div class="media-preview" id="mediaPreview" style="display:none; position:relative;"></div>

      <div class="create-post-footer">
        <div class="post-tools">
          <button class="tool-btn" id="attachMedia" title="Add photo/video">Photo/Video</button>
        </div>

        <div class="board-input-wrapper">
          <input type="text" id="boardInput" placeholder="Pick a community..." autocomplete="off">
          <div id="suggestions"></div>
        </div>
        <button class="post-submit-btn" id="submitPost" disabled>Post</button>
      </div>
    </div>

    <input type="file" id="mediaInput" accept="image/*,video/*" style="display:none;">
    <div class="gallery items"></div>
  </section>

  <div id="shared-footer"></div>

<script>
function timeAgo(date) {
  const s = Math.floor((Date.now() - new Date(date)) / 1000);
  let i = s / 31536000; if (i > 1) return Math.floor(i) + "y";
  i = s / 2592000; if (i > 1) return Math.floor(i) + "mo";
  i = s / 86400; if (i > 1) return Math.floor(i) + "d";
  i = s / 3600; if (i > 1) return Math.floor(i) + "h";
  i = s / 60; if (i > 1) return Math.floor(i) + "m";
  return "now";
}
function getPfp(id) { return localStorage.getItem("pfp_"+id) || "/users/default/pfp.jpg"; }

document.addEventListener("DOMContentLoaded", () => {
  fetch("../shared/header.html").then(r=>r.text()).then(h=>document.getElementById("shared-header").innerHTML=h);
  fetch("../shared/footer.html").then(r=>r.text()).then(f=>document.getElementById("shared-footer").innerHTML=f);

  const currentUserId = localStorage.getItem('currentUserId') || '';
  const loggedIn = localStorage.getItem('loggedIn') === 'true';
  const userPfp = getPfp(currentUserId);
  document.getElementById('currentUserPfp').src = userPfp;

  const textarea = document.getElementById('newPostText');
  const boardInput = document.getElementById('boardInput');
  const suggestionsBox = document.getElementById('suggestions');
  const submitBtn = document.getElementById('submitPost');
  const mediaPreview = document.getElementById('mediaPreview');
  const mediaInput = document.getElementById('mediaInput');
  let attachedMedia = null;

  // === BOARD AUTOCOMPLETE ===
  let availableBoards = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith('posts_/b/')) availableBoards.push(key.replace('posts_/b/', ''));
  }
  availableBoards = [...new Set(availableBoards)].sort();

  boardInput.addEventListener('input', () => {
    const q = boardInput.value.trim().toLowerCase();
    suggestionsBox.innerHTML = '';
    if (!q) { suggestionsBox.style.display = 'none'; return; }
    const matches = availableBoards.filter(b => b.toLowerCase().includes(q));
    if (!matches.length) { suggestionsBox.style.display = 'none'; return; }
    matches.forEach(b => {
      const div = document.createElement('div');
      div.className = 'suggestion-item';
      div.textContent = b;
      div.onclick = () => { boardInput.value = b; suggestionsBox.style.display = 'none'; updateButton(); };
      suggestionsBox.appendChild(div);
    });
    suggestionsBox.style.display = 'block';
  });

  // Close suggestions on outside click
  document.addEventListener('click', e => {
    if (!boardInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
      suggestionsBox.style.display = 'none';
    }
  });

  // === MEDIA UPLOAD ===
  document.getElementById('attachMedia').onclick = () => mediaInput.click();
  mediaInput.onchange = () => {
    const file = mediaInput.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      attachedMedia = { type: file.type.startsWith('video') ? 'video' : 'image', url: e.target.result };
      showMediaPreview();
    };
    reader.readAsDataURL(file);
  };

  function showMediaPreview() {
    if (!attachedMedia) { mediaPreview.style.display = 'none'; return; }
    mediaPreview.innerHTML = '';
    let el;
    if (attachedMedia.type === 'image') {
      el = document.createElement('img');
      el.src = attachedMedia.url;
    } else {
      el = document.createElement('video');
      el.src = attachedMedia.url;
      el.controls = true; el.autoplay = true; el.muted = true; el.loop = true;
    }
    mediaPreview.appendChild(el);
    const removeBtn = document.createElement('button');
    removeBtn.textContent = '×';
    removeBtn.className = 'remove-media';
    removeBtn.onclick = () => {
      attachedMedia = null;
      mediaPreview.style.display = 'none';
      mediaInput.value = '';
    };
    mediaPreview.appendChild(removeBtn);
    mediaPreview.style.display = 'block';
  }

  // === POSTING ===
  const updateButton = () => {
    const hasContent = textarea.value.trim() || attachedMedia;
    const hasBoard = boardInput.value.trim();
    submitBtn.disabled = !loggedIn || !hasContent || !hasBoard;
  };
  textarea.addEventListener('input', updateButton);
  boardInput.addEventListener('input', updateButton);

  submitBtn.addEventListener('click', () => {
    if (!loggedIn) return alert("Log in to post");
    const text = textarea.value.trim();
    const boardName = boardInput.value.trim();
    if ((!text && !attachedMedia) || !boardName) return;

    const userData = JSON.parse(localStorage.getItem(`user_${currentUserId}`) || '{}');
    const boardKey = `/b/${boardName}`;
    const key = `posts_${boardKey}`;
    let posts = JSON.parse(localStorage.getItem(key) || '[]');

    posts.unshift({
      id: Date.now(),
      username: userData.username || 'User',
      userId: currentUserId,
      text: text,
      media: attachedMedia ? { type: attachedMedia.type, url: attachedMedia.url } : null,
      timestamp: new Date().toISOString(),
      yeahs: [],
      replies: [],
      views: 0
    });

    localStorage.setItem(key, JSON.stringify(posts));
    textarea.value = ''; boardInput.value = ''; attachedMedia = null; mediaInput.value = '';
    mediaPreview.style.display = 'none'; updateButton();
    location.reload();
  });

  // === LOAD POSTS ===
  const gallery = document.querySelector('.gallery.items');
  let allPosts = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith('posts_')) {
      const posts = JSON.parse(localStorage.getItem(key) || '[]');
      posts.forEach(p => {
        p.board = key.replace('posts_', '');
        p.yeahs = p.yeahs || [];
        p.replies = p.replies || [];
        p.views = p.views || 0;
        allPosts.push(p);
      });
    }
  }
  allPosts.sort((a,b) => b.id - a.id);

  if (!allPosts.length) {
    gallery.innerHTML = '<p style="text-align:center;padding:80px;color:#888;">No posts yet — be the first!</p>';
    return;
  }

  gallery.innerHTML = allPosts.map(post => {
    const hasYeah = post.yeahs.includes(currentUserId);
    const profileUrl = `/users/${post.userId}/profile.html`;
    const avatar = getPfp(post.userId);
    const yeahText = hasYeah ? "Unyeah" : "Yeah!";
    const yeahCountText = post.yeahs.length === 1 ? "1 person gave this post a Yeah."
      : post.yeahs.length > 1 ? `${post.yeahs.length} people gave this post a Yeah.` : "";
    const cleanBoard = post.board.split('/').pop();

    let mediaHTML = '';
    if (post.media) {
      if (post.media.type === 'image') {
        mediaHTML = `<img src="${post.media.url}" style="max-width:100%; border-radius:8px; margin-top:10px;">`;
      } else if (post.media.type === 'video') {
        mediaHTML = `<video src="${post.media.url}" controls autoplay muted loop style="max-width:100%; border-radius:8px; margin-top:10px;"></video>`;
      }
    }

    return `
      <div class="post" data-id="${post.id}" data-board="${post.board}">
        <div class="post-avatar" onclick="location.href='${profileUrl}'">
          <img src="${avatar}" alt="${post.username}">
        </div>
        <div class="post-body">
          <div class="post-header">
            <strong onclick="location.href='${profileUrl}'">${post.username}</strong>
            <span class="post-meta">${timeAgo(post.timestamp)}</span>
            <span class="post-board">${cleanBoard}</span>
          </div>
          <div class="post-text">${post.text.replace(/\n/g, '<br>')}</div>
          ${mediaHTML}
          <div class="post-actions">
            <button class="yeah-btn ${hasYeah?'liked':''}" data-id="${post.id}" data-board="${post.board}">
              ${yeahText}
            </button>
            <div class="stats">
              <span>${post.replies.length} Replies</span>
              <span>${post.views} Views</span>
            </div>
          </div>
          <div class="yeah-section ${hasYeah ? 'visible' : ''}">
            ${yeahCountText ? `<div class="yeah-label">${yeahCountText}</div>` : ''}
            <div class="yeah-avatars">
              ${post.yeahs.slice(0,12).map(id => `<img src="${getPfp(id)}" alt="yeah">`).join('')}
              ${post.yeahs.length > 12 ? `<span>+${post.yeahs.length-12}</span>` : ''}
            </div>
          </div>
        </div>
      </div>`;
  }).join('');

  gallery.addEventListener('click', e => {
    const yeahBtn = e.target.closest('.yeah-btn');
    if (yeahBtn && loggedIn) {
      e.stopPropagation();
      const userId = currentUserId;
      const key = `posts_${yeahBtn.dataset.board}`;
      let posts = JSON.parse(localStorage.getItem(key)||'[]');
      const post = posts.find(p => p.id == yeahBtn.dataset.id);
      const idx = post.yeahs.indexOf(userId);
      if (idx > -1) post.yeahs.splice(idx,1);
      else post.yeahs.push(userId);
      localStorage.setItem(key, JSON.stringify(posts));
      location.reload();
      return;
    }
    const postDiv = e.target.closest('.post');
    if (postDiv && !e.target.closest('.yeah-btn')) {
      const board = postDiv.dataset.board;
      const id = postDiv.dataset.id;
      location.href = `/boards${board}/posts/${id}.html`;
    }
  });
});

		document.addEventListener("DOMContentLoaded", function () {
		  // Load header
		  fetch("../shared/header.html")
			.then(r => r.text())
			.then(html => {
			  document.getElementById("shared-header").innerHTML = html;

			  // NOW run the user section script AFTER header is inserted
			  const userSection = document.getElementById("userSection");
			  const loggedIn = localStorage.getItem("loggedIn") === "true";
			  const userId = localStorage.getItem("currentUserId");

			  if (loggedIn && userId) {
				const userData = JSON.parse(localStorage.getItem(`user_${userId}`));
				if (userData?.username) {
				  userSection.innerHTML = `
					<span class="username">${userData.username}</span>
					<a href="/users/${userId}/profile.html" class="user-avatar">
					  <img src="/users/default/pfp.jpg" alt="${userData.username}'s avatar">
					</a>
				  `;
				  return;
				}
			  }
			  // Not logged in
			  userSection.innerHTML = `<a href="/login.html" style="color:#007bff;font-weight:bold;text-decoration:none;">Create an account today!</a>`;
			});

		  // Load footer
		  fetch("../shared/footer.html")
			.then(r => r.text())
			.then(d => document.getElementById("shared-footer").innerHTML = d);
		});
</script>
</body>
</html>
